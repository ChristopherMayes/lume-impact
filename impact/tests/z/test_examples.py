import matplotlib.pyplot as plt
import numpy as np
import pytest

from impact.z.particles import ImpactZParticles

from ...z import ImpactZ, ImpactZInput
from .conftest import z_example1, z_examples_root


examples = pytest.mark.parametrize(
    ("example_input_file",),
    [
        pytest.param(z_example1, id="example1"),
    ],
)


@examples
def test_load_from_filename(example_input_file: ImpactZInput) -> None:
    ImpactZ(input=example_input_file)


@examples
def test_load_from_contents(example_input_file: ImpactZInput) -> None:
    with open(example_input_file, "rt") as fp:
        contents = fp.read()

    ImpactZ(input=contents)


@examples
def test_load_from_instance(example_input_file: ImpactZInput) -> None:
    input = ImpactZInput.from_file(example_input_file)
    ImpactZ(input=input)


# TODO this needs rearranging
example1_data = {
    "932": np.array(
        [
            1.99997702434509,
            1.53975725471636,
            -2.196807406333129e-05,
            0.628615148538444,
            -1.836337241576689e-05,
            0.009509472946725956,
            -9.019382983044043e-07,
            -0.132670020506737,
            7.584087620470457e-06,
            -0.05559846979280019,
            4.312514779563946e-06,
            0.009952662352711758,
            -6.774189617057299e-07,
            0.01684240247735793,
            -1.784125232393213e-06,
            0.003497779825887112,
            -5.486825787755395e-07,
            -0.002891787118469428,
            3.366881229422849e-07,
            -0.001853194707445747,
            2.951690814461029e-07,
            5.31639433761795e-05,
            -1.658720074231425e-09,
            0.0005153326281966993,
            -1.289718748389961e-07,
            0.0002979142129147272,
            -1.102177570651494e-07,
            7.627157752204657e-05,
            -6.50285721521375e-08,
            -5.392706189655232e-05,
            -1.517431486015614e-08,
            -0.0001322093601535543,
            2.112846832665866e-08,
            -0.000156567744870032,
            4.407024148068742e-08,
            -0.0001101398983375894,
            3.416545869051831e-08,
            4.383476463469812e-05,
            -1.057120672001008e-08,
        ]
    ),
    "916": np.array(
        [
            1.99997667437436,
            1.53651440738977,
            2.295062403766246e-05,
            0.623913851279348,
            1.850149755325963e-05,
            0.01003532369918821,
            2.99405316253879e-07,
            -0.128492677588814,
            -7.664305152977744e-06,
            -0.0531671729588179,
            -3.86052912871341e-06,
            0.009512481835878555,
            9.056879999584602e-07,
            0.01571182208262119,
            1.610455715169011e-06,
            0.003130320870736345,
            3.172342819333295e-07,
            -0.002687902403876023,
            -3.889760674597555e-07,
            -0.001658124456360384,
            -2.418275640240754e-07,
            8.113201340734289e-05,
            3.880314915888695e-08,
            0.0004854414166001327,
            1.028973720176488e-07,
            0.0002822637762417697,
            4.479086753643548e-08,
            6.939571784395084e-05,
            -1.273952447122957e-08,
            -6.056603385887651e-05,
            -2.166622585619362e-08,
            -0.0001413041908465478,
            -2.183599237193593e-08,
            -0.0001625289717525915,
            -2.709977743778928e-08,
            -0.0001004502065973874,
            -2.906967693389758e-08,
            6.44940945237726e-05,
            7.715343497537783e-09,
        ]
    ),
    "852": np.array(
        [
            1.99997526464407,
            1.52106541470653,
            9.148700746534131e-08,
            0.601258524203007,
            -2.157827927419886e-07,
            0.01054224818199588,
            -3.255162599341416e-07,
            -0.1119829055094,
            -4.665413654178449e-08,
            -0.04350527301900405,
            1.671920721749503e-07,
            0.007987342120152632,
            1.088147639336722e-07,
            0.0117386658298024,
            -2.027366191831394e-08,
            0.002099866809936222,
            -7.237328321811554e-08,
            -0.001765656614540568,
            -4.883244626335518e-08,
            -0.001030176413601768,
            -1.741828766489955e-08,
            -7.012053142066631e-05,
            1.474233068488982e-08,
            0.0001103101352248397,
            1.441657589563535e-08,
            7.821074292346977e-05,
            7.503795344198531e-10,
            8.647232197801117e-05,
            -1.473914817244901e-08,
            0.0001385568404002706,
            -6.440246054360356e-11,
            0.0001127581875668796,
            1.608742754126417e-09,
            -1.724744998139629e-05,
            4.74511548745443e-09,
            -0.00014730866312778,
            -1.158737158407436e-08,
            -0.0001294426712443825,
            -1.227889477235713e-08,
        ]
    ),
    "884": np.array(
        [
            1.99997619270459,
            1.52935883963703,
            -1.731598297715639e-05,
            0.613504569354096,
            -1.427701807723931e-05,
            0.0107465110577257,
            -7.903590795452165e-07,
            -0.120104391407645,
            5.464232701763001e-06,
            -0.04829733452170583,
            3.023544570585286e-06,
            0.008655111662731007,
            -4.518220648464494e-07,
            0.01352061812131545,
            -1.130150243029969e-06,
            0.002441913680719964,
            -2.911000780140425e-07,
            -0.002264367882917796,
            2.397012204769587e-07,
            -0.001248848251648092,
            1.692432652543088e-07,
            0.0001536260367082622,
            -1.630675933926556e-08,
            0.0004126329537334329,
            -7.30578002571497e-08,
            0.0002062265939100274,
            -1.915347872597266e-08,
            -7.296679175445152e-07,
            4.999918991808733e-08,
            -0.0001043101508213657,
            8.126737257973211e-08,
            -0.0001248100138844216,
            2.219076121988753e-08,
            -9.00537625716291e-05,
            -5.805407627166028e-08,
            -2.421266376838097e-05,
            -8.987394602659962e-08,
            9.504835486433592e-05,
            -4.955001233199534e-08,
        ]
    ),
    "981": np.array(
        [
            1.99997751084392,
            1.54810253541094,
            -2.102513462123201e-05,
            0.640442424459799,
            -1.782080147104581e-05,
            0.006971280893198023,
            -8.068094968763484e-07,
            -0.145111655134944,
            7.857263080707077e-06,
            -0.06267132265318345,
            4.591452480024242e-06,
            0.01151363018928121,
            -7.540119518327617e-07,
            0.02051164759509596,
            -2.04736427763202e-06,
            0.00472301714192016,
            -6.568407253006851e-07,
            -0.003597380976665165,
            4.326171571842291e-07,
            -0.002586677188035839,
            4.383490750063557e-07,
            -0.000100310171942163,
            7.571866062866606e-08,
            0.000589376652629424,
            -1.143479338137782e-07,
            0.0003489215123795833,
            -1.213179381948115e-07,
            0.0001548941351258642,
            -8.37933632350729e-08,
            6.780552420995716e-05,
            -2.851843384444498e-08,
            -5.909558891998587e-05,
            4.667392520124655e-08,
            -0.0001842649023506177,
            1.063806496489019e-07,
            -0.0002062608356349959,
            9.115855941880307e-08,
            -7.15920359328421e-05,
            1.39993669300869e-08,
        ]
    ),
    "868": np.array(
        [
            1.99997584392422,
            1.52536177988978,
            -2.351841107605182e-05,
            0.607635489477361,
            -1.91609058995536e-05,
            0.01081867464479435,
            -9.659874382214427e-07,
            -0.115921348778298,
            7.166528016675878e-06,
            -0.04582578381601511,
            3.83401850058108e-06,
            0.008300367358460257,
            -6.220469287099575e-07,
            0.01252762598625653,
            -1.408873921034065e-06,
            0.002157799831643168,
            -3.382480622124355e-07,
            -0.002071762763265125,
            2.975029021763944e-07,
            -0.001100462731059474,
            2.063091233440562e-07,
            0.000154475937557416,
            -4.231576992776776e-10,
            0.0003706193741058561,
            -5.951169956414006e-08,
            0.0001845661768969011,
            -1.809150457488791e-08,
            5.251355253685075e-06,
            2.158372657629479e-08,
            -8.058917036329476e-05,
            4.100209153468879e-08,
            -0.0001089659697366076,
            1.348702641917654e-08,
            -8.696966228314929e-05,
            -3.112282764120351e-09,
            -2.191888068491521e-05,
            2.150206808554732e-09,
            9.370706427499619e-05,
            1.962995015093624e-08,
        ]
    ),
    "949": np.array(
        [
            1.99997701681804,
            1.542753631449,
            5.589737581277825e-06,
            0.632896556168902,
            4.335443063456231e-06,
            0.008762817747970487,
            -1.982379002138828e-07,
            -0.136900488651551,
            -1.976622981479269e-06,
            -0.05803477580505652,
            -8.383804663379883e-07,
            0.01044272055289367,
            3.505579591485973e-07,
            0.01807477035029528,
            4.291930668425559e-07,
            0.003955259098895229,
            5.121689510968374e-08,
            -0.003072034551344477,
            -1.313123814877663e-07,
            -0.002093395219274164,
            -1.048770418793586e-07,
            -5.269809847050732e-05,
            -3.361058955956442e-08,
            0.0004756927399842138,
            1.722506599395943e-08,
            0.0002856422278065735,
            4.610113822493056e-08,
            0.0001179735548837432,
            3.841337946296887e-08,
            3.874076415189492e-05,
            1.185269090984868e-08,
            -4.444378778227386e-05,
            -2.351523290176029e-08,
            -0.0001362236768443235,
            -4.00884119488385e-08,
            -0.0001713171129908515,
            -2.678290636527787e-08,
            -5.762514841471421e-05,
            1.697161098010104e-08,
        ]
    ),
    "965": np.array(
        [
            1.99997721976241,
            1.5455189413295,
            9.857760069157053e-08,
            0.636809212337518,
            -2.195389195645625e-07,
            0.007906205763086966,
            -3.609904611077265e-07,
            -0.141032541184925,
            -3.872125436621476e-08,
            -0.06036832492192128,
            2.370235172564634e-07,
            0.01098449102890338,
            1.498992149903873e-07,
            0.01930922510475182,
            -5.532218671756797e-08,
            0.004353213547371999,
            -1.075369329920157e-07,
            -0.003337298794365224,
            -2.568141052768229e-08,
            -0.002362615312413001,
            3.380101916682292e-08,
            -0.0001033266010714333,
            2.3223377529072e-08,
            0.0005210430853415992,
            -1.513560495374331e-08,
            0.0003297787286256089,
            -3.665440303160479e-08,
            0.0001670388679138105,
            -3.576120053756224e-08,
            8.090696170021121e-05,
            -3.069697306644939e-09,
            -5.007971706256843e-05,
            2.788217196803122e-08,
            -0.0001856942270816465,
            3.004544225068639e-08,
            -0.0002187353899614409,
            1.016300537640453e-08,
            -7.802550167116034e-05,
            7.561532494944768e-09,
        ]
    ),
    "900": np.array(
        [
            1.9999763223414,
            1.53306981679688,
            1.156951845716257e-05,
            0.618927482365336,
            9.109681518074322e-06,
            0.01049719633898192,
            -3.532970061626495e-08,
            -0.124283111454312,
            -3.756512857737975e-06,
            -0.05074960318450528,
            -1.72990341578592e-06,
            0.009041500296720526,
            5.238153583849631e-07,
            0.0145694667059413,
            7.481221396141082e-07,
            0.002764490976357903,
            1.109407076961658e-07,
            -0.00246554829925557,
            -1.739834338690722e-07,
            -0.001420743540472927,
            -7.631925157482176e-08,
            0.000150581333402916,
            4.410958722062289e-08,
            0.0004563677719816846,
            4.535413734145647e-08,
            0.0002224351098835208,
            4.87419056722278e-09,
            5.53164355674976e-06,
            -2.500797900518477e-08,
            -0.0001014383023152986,
            -1.343727120312497e-08,
            -0.0001350122939304124,
            8.886520829723918e-09,
            -0.0001060258900634123,
            1.371648856484323e-08,
            -3.068872528649018e-05,
            -1.657685779780816e-08,
            9.471288405298918e-05,
            -1.933322735731023e-08,
        ]
    ),
}


@examples
def test_run_example(example_input_file: ImpactZInput) -> None:
    I = ImpactZ(
        input=example_input_file,
        initial_particles=ImpactZParticles.from_file(z_examples_root / "particle1.in"),
        file_data=example1_data,
    )
    I.input.lattice = I.input.lattice[:3]
    I.input.update_particle_parameters()  # for coverage
    output = I.run()
    print(output)

    I.plot()
    plt.show()
